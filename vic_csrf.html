<!DOCTYPE html>
<html>
<head>
    <title>CSRF 데모: 피해자 사이트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        input, button { padding: 8px; margin: 10px 0; display: block; width: 250px;}
        .vulnerable { color: red; font-weight: bold; border: 1px solid red; padding: 10px; margin-bottom: 20px;}
        .safe { color: green; font-weight: bold; border: 1px solid green; padding: 10px; margin-bottom: 20px;}
        pre { background: #f4f4f4; padding: 10px; overflow: auto; }
        .result-box { border: 1px solid #ccc; padding: 15px; margin-top: 20px; background-color: #f9f9f9; }
        h2, h3 { color: #333; }
        form div { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>CSRF 데모: 피해자 사이트</h1>
        <p>이 페이지는 비밀번호 변경 기능을 제공합니다. 사용자가 이 페이지에 로그인되어 있다고 가정하고,
           공격자 사이트에서 이 페이지로 위조된 요청을 보낼 때 어떤 일이 발생하는지 시뮬레이션합니다.</p>
        
        <h2>로그인 상태 시뮬레이션</h2>
        <p>이 페이지는 항상 '로그인'되어 있는 것으로 가정합니다.</p>
        <p><strong>현재 사용자:</strong> `user123`</p>
        <p><strong>현재 비밀번호:</strong> `<span id="currentPasswordDisplay">initial_password</span>`</p>

        <hr>

        <div class="vulnerable">
            <h2>취약한 비밀번호 변경 기능</h2>
            <p>이 폼은 CSRF 토큰이나 Referer 검사와 같은 방어 메커니즘이 없습니다.</p>
            <form id="vulnerablePasswordForm">
                <div>
                    <label for="vulnNewPassword">새 비밀번호:</label>
                    <input type="text" id="vulnNewPassword" name="new_password" value="new_vulnerable_pass">
                </div>
                <button type="button" onclick="changeVulnerablePassword()">비밀번호 변경 (취약)</button>
            </form>
            <div class="result-box">
                <strong>결과:</strong> <span id="vulnResult"></span>
            </div>
        </div>

        <hr>

        <div class="safe">
            <h2>안전한 비밀번호 변경 기능 (CSRF 토큰 사용)</h2>
            <p>이 폼은 CSRF 토큰을 사용하여 요청이 위조되었는지 확인합니다.</p>
            <form id="safePasswordForm">
                <div>
                    <label for="safeNewPassword">새 비밀번호:</label>
                    <input type="text" id="safeNewPassword" name="new_password" value="new_safe_pass">
                </div>
                <input type="hidden" id="csrfToken" name="csrf_token" value=""> <!-- CSRF 토큰이 들어갈 곳 -->
                <button type="button" onclick="changeSafePassword()">비밀번호 변경 (안전)</button>
            </form>
            <div class="result-box">
                <strong>결과:</strong> <span id="safeResult"></span>
            </div>
        </div>

        <hr>

        <h2>이 공격을 시도하는 방법</h2>
        <ol>
            <li>이 `victim-site.html` 페이지를 엽니다. (로그인된 상태를 시뮬레이션)</li>
            <li>새 탭/창에서 `attacker-site.html` 파일을 엽니다.</li>
            <li>`attacker-site.html`에서 'CSRF 공격 시도!' 버튼을 클릭합니다.</li>
            <li>`victim-site.html`로 돌아와 '현재 비밀번호'를 확인하고, 변경 결과 메시지를 확인합니다.</li>
        </ol>
        
    </div>

    <script>
        let currentPassword = "initial_password"; // 현재 비밀번호 시뮬레이션
        document.getElementById('currentPasswordDisplay').textContent = currentPassword;

        // CSRF 토큰 생성 (클라이언트 측에서 간단히 시뮬레이션)
        // 실제 웹 앱에서는 서버에서 생성하여 매 요청마다 유효성 검사.
        function generateCsrfToken() {
            const token = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            document.getElementById('csrfToken').value = token;
            return token;
        }

        // 페이지 로드 시 CSRF 토큰 생성
        window.onload = generateCsrfToken;

        // 취약한 비밀번호 변경 기능 시뮬레이션
        // 이 함수는 외부에서 호출될 수 있는 '취약점' 역할을 합니다.
        function changeVulnerablePasswordFromExternal(newPass) {
            const resultElement = document.getElementById('vulnResult');
            const displayElement = document.getElementById('currentPasswordDisplay');

            if (!newPass || newPass === "") {
                resultElement.textContent = "새 비밀번호가 유효하지 않습니다.";
                resultElement.style.color = "orange";
                return;
            }

            // 실제 웹 서버라면 여기서 DB를 업데이트
            currentPassword = newPass;
            displayElement.textContent = currentPassword;
            resultElement.textContent = `비밀번호가 '${newPass}'(으)로 변경되었습니다. (취약점을 통해 공격됨!)`;
            resultElement.style.color = "red";
        }

        // 폼에서 취약한 비밀번호 변경 호출 (사용자가 직접 입력)
        function changeVulnerablePassword() {
            const newPass = document.getElementById('vulnNewPassword').value;
            changeVulnerablePasswordFromExternal(newPass);
            document.getElementById('vulnNewPassword').value = "new_vulnerable_pass"; // 초기화
        }

        // 안전한 비밀번호 변경 기능 시뮬레이션 (CSRF 토큰 검증)
        function changeSafePassword() {
            const newPass = document.getElementById('safeNewPassword').value;
            const userProvidedToken = document.getElementById('csrfToken').value; // 사용자 폼이 보낸 토큰
            const actualToken = document.getElementById('csrfToken').value; // 현재 페이지의 토큰 (시뮬레이션)

            const resultElement = document.getElementById('safeResult');
            const displayElement = document.getElementById('currentPasswordDisplay');

            if (userProvidedToken === actualToken) {
                // 토큰 일치: 정상적인 요청
                currentPassword = newPass;
                displayElement.textContent = currentPassword;
                resultElement.textContent = `비밀번호가 '${newPass}'(으)로 변경되었습니다. (정상 요청)`;
                resultElement.style.color = "green";
                generateCsrfToken(); // 토큰 재발급 (일회용 토큰이라면)
            } else {
                // 토큰 불일치: CSRF 공격 시도 또는 토큰 유효성 문제
                resultElement.textContent = "비밀번호 변경 실패: CSRF 토큰이 유효하지 않습니다.";
                resultElement.style.color = "red";
            }
            document.getElementById('safeNewPassword').value = "new_safe_pass"; // 초기화
        }

        // URL 매개변수를 이용한 취약점 트리거 (공격자 사이트에서 이 링크를 호출하도록)
        // 예를 들어 attacker.html에서 <img src="victim-site.html?action=changePass&new_password=hacked_by_csrf">
        const params = new URLSearchParams(window.location.search);
        if (params.has('action') && params.get('action') === 'changePass' && params.has('new_password')) {
            const attackedPassword = params.get('new_password');
            changeVulnerablePasswordFromExternal(attackedPassword);
            // URL 파라미터를 사용한 공격은 주로 GET 요청에 해당.
            // POST 요청은 숨겨진 폼을 사용하지만, 정적 웹페이지에서는 구현이 복잡
        }
    </script>
</body>
</html>